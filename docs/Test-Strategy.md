# テストコード完備のための方針

このドキュメントは、BetterRecolor（ButtonTextReColorizer）のテストを段階的に充実させるための方針をまとめたものです。  
「まず壊れやすい部分を最小コストで守る」→「I/Oや例外も含めて網羅的にする」という順で進めます。

## 基本方針

- 小さく始めて継続的に増やす（最小テスト → 重要処理 → I/O → 例外）
- 失敗理由が分かりやすいテストを書く（入力・期待値を明確に）
- 外部依存は極力モック化する（実ファイルや外部ツールに依存しない）
- 実データ由来のテストは最小限にし、重い処理は避ける

## フェーズ別の進め方

### フェーズ1: ロジックの中核（すでに着手済み）

目的: 変換ロジックの回帰を防ぐ

- `btrc/brlyt.py` の `apply_tev_colors`
- `btrc/brlan.py` の `update_tev_colors` / `select_color_rule`

### フェーズ2: I/O・ファイル操作

目的: 実行時に壊れやすい周辺処理を固める

- `copy_all` が階層構造・ファイル数を維持できるか
- `reset_dir` がディレクトリを安全に再作成できるか
- `move_all_files` が意図した移動を行えるか
- `remove_json5_files` が指定ファイルを削除できるか

テスト方針:
- `pytest` の `tmp_path` を利用して一時ディレクトリで完結
- 空ディレクトリや空ファイルもケースに含める

### フェーズ3: JSON5 I/O

目的: 破損データや形式崩れに対する耐性を確認

- `read_json5` が正常データを読み込めるか
- 破損したJSON5で例外が発生するか
- `write_json5` が読み込んだ内容を保ったまま書き出せるか

### フェーズ4: 実行フロー（統合テスト）

目的: mainの処理手順が破綻しないことを最低限保証

- `main` の主要フローを部分的に統合テスト
- 外部依存（`wuj5` 等）はモック化

テスト方針:
- 全体E2Eではなく、部分的な統合テストに止める
- `encode_json5_files` などは `monkeypatch` でダミー化

### フェーズ5: i18n / 入力まわり

目的: ユーザー入力や多言語対応の安定性を保つ

- `set_locale` が未知言語で落ちない
- `t()` が未知キーで落ちない
- `run_color_input_flow` の最小経路テスト（入力を固定）

## 推奨するテスト構成

```
tests/
  test_brlyt.py
  test_brlan.py
  test_io.py
  test_json5_io.py
  test_flow.py
  test_i18n.py
```

## 実行方針（CI含む）

- ローカルでは `ruff` → `pytest` の順で実行
- CIは `push` / `pull_request` で自動実行
- 実データを使うテストは必要最低限にする

## 追加の判断基準

以下に該当する機能は優先的にテスト追加する:

- 一度でもバグが出た箇所
- データ破損や消失のリスクがある処理
- ファイル数が多くなる処理（バッチ処理）

---

必要に応じて、この方針に沿ってテストケースを追加していきましょう。
